<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Tiffany's Lab 7</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap Icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
        <!-- SimpleLightbox plugin CSS-->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <link rel=stylesheet href="bootstrap.min.css">
        <style>
        body {
          background-image: url('../assets/img/Grid_paper.webp');
          background-repeat: no-repeat;
          background-attachment: fixed; 
          background-size: cover;
        }
        </style>
    </head>
    <body id="page-top">
          
        <!-- About-->
        <section class="page-section bg-warning" id="about">
            <p style="background-image: url('../assets/img/Grid_paper.webp');">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8 text-center">
                        <h2> Lab 7: Kalman Filter</h2>
                        <hr class="divider divider-light" />
                        <p> In this lab, I implemented a Kalman filter for my robot. The Kalman filter supplements sampled ToF sensor values
                            in order to achieve more granular data, which can be use to execute more precise movement control. The goal is to 
                            find the optimal combination of ToF data and position prediction based on pwm input to find the most precise estimate
                            of the robot's actual position. With this increased control, the robot will be able to speed more quickly towards the
                            wall while still stopping at precisely the 1 ft setpoint distance. </p>
                        
                        <div class="list-group">
                          <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                            <div class="d-flex w-100 justify-content-between">
                              <h5 class="mb-1">Estimate drag and momentum</h5>
                            </div>
                            <p class="mb-1">
                                In order to create a suitable Kalman filter for my robot, I first defined a state space model based off of Prof. Petersen's
                                lecture. The model is as follows:
                                
                                <img src="assets/img/kf_state_space.png" alt="State Space Model" width=60% height=auto/>
                                
                                In this model, let's define matrix A as the square matrix with the -d/m term, and matrix B as the [0, 1/m] matrix. 
                                These matrices involve the d and m coefficients, which represent the drag and momentum of the robot as it moves.
                                The equations for d and m are as follows:
                                
                                <img src="assets/img/kf_d_m.png" alt="Drag and Momentum equations" width=60% height=auto/>
                                
                                In order to find the values of drag and momentum for my robot, I triggered a step response and measured the ToF sensor readings and PWM 
                                input as the robot moved. I drove the robot at a PWM of 120, since that was the approximate speed it drove during PID in the previous lab. 
                                I then plotted graphs of the position (u), pwm, and velocity (x') of the robot:
                            </p>    
                        </a>
                    </div>
                        <br>
                            <img src="assets/img/kf_pos_final.png" alt="KF" width=70% height=auto/>
                        <br><br>
                            <img src="assets/img/kf_pwm_final.png" alt="KF" width=70% height=auto/>
                        <br><br>
                            <img src="assets/img/kf_vel_final.png" alt="KF" width=70% height=auto/>
                        <br><br>
                            <p class="mb-1">
                                From these graphs, I can determine the steady state velocity, which is the (peak) velocity at which the robot stops accelerating,
                                and the 90% rise time, which is the time it takes to reach 90% of the steady state velocity.
                            </p>    
                        
                            <div class="card border-info mb-3" style="max-width: 20rem;">
                              <div class="card-body">
                                <p class="card-text">
                                    Steady state velocity (ẋ) = 1800 mm/s 
                                    <br>
                                    90% rise time (t<sub>0.9</sub>) = 1.5 s
                                  </p>
                              </div>
                            </div>
                            <p class="mb-1">
                                Using the above values, drag and mass can next be calculated. In the drag equation,
                                the value of u is assumed to be 1 in accordance with the lecture. As a result, we get that d = 0.000555, and m = 0.00326. 
                            </p>    
                            <div class="card border-danger mb-3" style="max-width: 35rem;">
                              <div class="card-body">
                                <p class="card-text">
                                    Drag (d) = u / ẋ = 1 / 1800 = 0.000555
                                    <br>
                                    Mass (m) = -dt<sub>0.9</sub> / ln(1-0.9) = -0.0005 * 1.5 / ln(1-0.9) = 0.00326
                                  </p>
                              </div>
                            </div>
                        <p class="mb-1">
                                The calculated values for drag and mass are plugged to the A and B matrices from our Kalman filter equations, resulting
                                in the matrices below.
                        </p>    
                        <br>
                            <img src="assets/img/a_matrix.png" alt="A Matrix" width=45% height=auto/>
                            <img src="assets/img/b_matrix.png" alt="B Matrix" width=35% height=auto/>
                        <br><br>
                        
                        <div class="list-group">
                          <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                            <div class="d-flex w-100 justify-content-between">
                              <h5 class="mb-1">Initialize Kalman Filter</h5>
                            </div>
                            <p class="mb-1"> After measuring my robot's step response, I now have all the data I need to initialize the Kalman filter. This can
                                be done in 4 steps, as follows:
                              </p>
                          </a>
                        </div>
                        <br>
                        <div class="card text-white bg-danger mb-3" style="max-width: 50rem;">
                          <div class="card-header">1. Discretize A and B matrices based on sampling rate</div>
                          <div class="card-body">
                            <p class="card-text">To discretize my A and B matrices, I first determined the sampling rate by finding the average
                              difference between TOF sample timestamps. I found the Δt to be 0.093 seconds.
                              <br>
                              <img src="assets/img/sampling_frequency.png" alt="Sampling Frequency" width=30% height=auto/>
                              <br><br>
                              Using this Δt value, I implemented the following code from the lab manual to discretize the A and B matrices.
                              <img src="assets/img/discretized_matrices.png" alt="Discretized Matrices" width=70% height=auto/>
                            </p>
                          </div>
                        </div>
                        <div class="card text-white bg-info mb-3" style="max-width: 50rem;">
                          <div class="card-header">2. Identify C matrix</div>
                          <div class="card-body">
                            <p class="card-text">The C matrix used in my Kalman filter is the one given in class. Since we are only measuring the
                              negative distance from the wall, the position corresponding to velocity in the matrix is 0. 
                                <br>
                                <code> C = np.array([[-1, 0]]) </code>
                            </p>
                          </div>
                        </div>
                        <div class="card text-white bg-success mb-3" style="max-width: 50rem;">
                          <div class="card-header">3. Initialize state vector, x</div>
                          <div class="card-body">
                              <p class="card-text"> <code> x = np.array([[-tof_data[0]],[0]]) </code> </p>
                          </div>
                        </div>
                        <div class="card text-white bg-warning mb-3" style="max-width: 50rem;">
                          <div class="card-header">4. Specify process noise and sensor noise covariance matrices</div>
                          <div class="card-body">
                            <p class="card-text">Lastly, the Kalman filter requires calculation of the process noise and sensor noise matrices.
                                The process noise matrix, Σ<sub>u</sub>, has two covariance values σ<sub>1</sub> and σ<sub>2</sub>. 
                                The sensor noise matrix, Σ<sub>z</sub>, has one covariance value σ<sub>3</sub>. 
                            </p>
                              <img src="assets/img/kf_noise.png" alt="Noise Covariance Matrices" width=30% height=auto/>
                              <br><br>
                              <p class="card-text">Using the same sampling rate that I calculated to discretize the A and B matrices, I can calculate
                                  σ<sub>1</sub> and σ<sub>2</sub> with the following equations:
                            </p>
                              <img src="assets/img/process_noise_covariance.png" alt="Noise Covariance" width=60% height=auto/>
                              <br><br>
                              <p class="card-text">Taking σ<sub>3</sub> to be 20mm, as suggested in the lecture, I now have all 3 covariance values
                                  needed to generate my noise matrices. 
                            </p>
                              <img src="assets/img/kf_noise_matrices.png" alt="Noise Covariance" width=40% height=auto/>
                              <p class="card-text">(Correction: The second matrix should be Σ<sub>z</sub>, not Σ<sub>u</sub>. Sorry about that!) 
                            </p>
                          </div>
                        </div>
                    <div class="list-group">
                          <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                            <div class="d-flex w-100 justify-content-between">
                              <h5 class="mb-1">Implement and test Kalman Filter in Jupyter</h5>
                            </div>
                            <p> 
                                Using the above parameters, the code to implement the Kalman filter is as follows:
                            </p>
                        </a>
                    </div>
                              <script src="https://gist.github.com/tiffanyguo8/29e2fa0a5e31917b90128eb6b128bd93.js"></script>
                                <p> 
                                  I graphed the generated array of Kalman-filtered data along with the raw TOF sensor readings. With a σ<sub>3</sub>
                                  value of 20, the filtered data appeared very similar to the raw data but slighly higher at some points. 
                                </p>
                              <img src="assets/img/kf_20.png" alt="Kalman filter vs Raw data" width=70% height=auto/>
                        <br><br>
                                <p> 
                                    With a σ<sub>3</sub> value of 10, the fit was even more exact, making the effect of the Kalman filter unnoticable. 
                                </p>
                              <img src="assets/img/kf_10.png" alt="Kalman filter vs Raw data" width=70% height=auto/>
                        <br><br>
                                <p> 
                                    Lastly, if I increase σ<sub>3</sub> to 100, placing much greater value on the predicted position data over sensor readings,
                                    the filtered data shifts far away from the raw TOF data, as expected. 
                                <br>
                        <br>
                              <img src="assets/img/kf_100.png" alt="Kalman filter vs Raw data" width=70% height=auto/>
                           </p>
                        <br>
                    
                         <div class="list-group">
                          <a href="#" class="list-group-item list-group-item-action flex-column align-items-start active">
                            <div class="d-flex w-100 justify-content-between">
                              <h5 class="mb-1">Implement the Kalman filter on the Robot!</h5>
                            </div>
                            <p> 
                                After verifying that the parameters chosen for the Kalman filter are effective, I simply transfered the Kalman filter logic from 
                                Python to Arduino code on the Artemis board so that it can perform PID using real-time Kalman filtered data. 
                            </p>
                          </a>
                        </div><br>
                        In my code, which is inspired by <a href="https://anyafp.github.io/ece4960/labs/lab7/">Anya's</a> code, 
                        I used the BasicLinearAlgebra Arduino library to help with matrix operations. 
                        <br>
                              <script src="https://gist.github.com/tiffanyguo8/dd4e8eca48aa9cecf29e37f7487676d2.js"></script>
                              <p><br>
                                Here is a video demo of my robot running PID control using the Kalman filter data:
                              </p>
                        <br>
                               <iframe width="560" height="315" src="https://www.youtube.com/embed/VnqafEW0-fo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        <br><br>      
                        <p>
                                I found that the parameters used earlier in my Python code worked well for my robot, and playing around with the σ values 
                                  either caused the motors to move unexpectedly/stall or caused the filtered data to be too close to the raw data. Thus, I stuck
                                  with the parameters I calculated earlier and generated the following graph from my PID run with Kalman filtered data. 
                              </p>
                        
                            <img src="assets/img/Kalman_filter_implemented.png" alt="Kalman filter" width=70% height=auto/>
                        <br><br>
                        <div class="d-grid gap-2">
                           <a class="btn btn-lg btn-primary" href="index.html">Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
            
        <!-- Footer-->
        <footer class="bg-light py-5">
            <div class="container px-4 px-lg-5"><div class="small text-center text-muted">Copyright &copy; 2023 - Tiffany &Co</div></div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- SimpleLightbox plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
